Задание 5* выполнено не совсем верно.

Эталонное решение вновь демонстрирует очень сильный анализ БД и использование по максимуму возможности выборки.
Что хочу отметить, в задании я указывал на отсутствие описания некоторых таблиц, поэтому не совсем понимал как делать некоторые анализы.
Смотря на эталон, видно как раз, что это и требовалось для учета сезонных факторов риска, определения защищенности крепости.
И в эталоне как всегда глубокий анализ с выводом большей информации.  
Всегда лучше следует читать описание задания, ведь только сейчас понял, как они хорошо описывают каждый CTE. 
И не надо сразу смотреть на возможный пример, а я во всех задания постоянно ориентировался на то, какой должен быть вариант выдачи и отображение анализа.

В CTE **_creature_attack_history_** собираются данные по всем атакам и их полные описания т.е история всех атак существ и их исходов. 
Я же использую историю угроз и вывожу только те данные, которые требовались для примера. Хотя по части модульности в эталоне более гибкий подход.

В CTE **_defense_structure_effectiveness_**, аналог моего **_fortress_defence_info_** ведется анализ эффективности защитных сооружений. 
В моем случае я считал что успешные отраженные атаки это **_ca.outcome = 'Defended'_**, в эталоне это оказалось **_ca.outcome = 'Repelled'_**.
Также здесь имеются некоторые поля, которые я не мог предположить, ввиду отсутствия описания **_defense_structures_**, и после становится понятно что
имелось ввиду, под полем **_defense_structures_used_** в таблице **_creature_attacks_**.

В CTE **_zone_vulnerability_**, аналог моего **_vulnerability_analysis_**, происходит оценка уязвимых зон на основе архитектуры крепости.
Я считал что **_military_response_time_** время отклика отряда считается из **_military_response_time_minutes_** таблицы **_creature_attacks_**. 
Но как оказалось в таблице **_military_stations_** есть поле **_response_time_to_zone_** и нужно брать минимальное значение для него, что в принципе логично, 
зная все поля всех таблиц. И здесь также имеются некоторые поля, которые я не мог предположить, ввиду отсутствия описания **_military_stations_** и **_squad_movement_**.
Да и корректно больше полей из таблицы **_locations_**, чтобы затем их можно было использовать в других анализах, 
особенно при подсчете **_vulnerability_score_** в основном запросе.

В CTE **_seasonal_attack_patterns_** собираются данные по атакам между сезонными факторами, погодой и фазами луны, чтобы потом в основном запросе посчитать
корреляцию между сезонными факторами и частотой нападений. Я упустил этот момент, ввиду того, что опять же, ориентировался на вариант выдачи вместо описания задачи.
Тут также требовались описания **_weather_records_** и **_moon_phases_**.

В CTE **_military_readiness_**, аналог моего **_military_readiness_info_** анализируется готовность военных отрядов и их расположение.
Здесь также учитывается больше показателей, чем в моем CTE. Также присутствуют таблицы, описание которых я не знал **_military_stations_** и **_squad_battle_participation_**.
Также я не учел что есть вариант исхода как частично пробитая, поврежденная крепость **_WHEN ca.outcome IN ('Repelled', 'Partial Breach')_**. 
Также здесь учитываются сколько дней прошло после тренинга, дата последнего тренинга, среднее время ответа по зоне, кол-во битв в которых принимал участие отряд, 
минимальное и среднее качество экипировки, качество экипировки потребуется для расчета _**combat_effectiveness**_.
Также я соединял гномов со скиллами **_('Combat', 'Military')_**, в эталоне достаточно **_'Combat'_**. Также забыл добавить условие выборки **_sm.active = TRUE_**.

В CTE **_fortress_security_evolution_**, аналог моего **_security_evolution_history_** идет анализ эволюции защитных способностей крепости со временем.
Показатель улучшения от года к году рассчитан верно. Также здесь есть дополнительные поля для лучшего анализа: коэффициент отраженных атак, средняя по качеству защиты, 
средний уровень фортификаций, взвешенная военная готовность, инвестиции в оборону. Также ввиду отсутствия описания таблицы **_fortress_events_** 
не мог знать что требуется выборка по **_e.event_type = 'Security Assessment'_**.

В заключении сравниваем мой основной запрос с эталонным.  

_Анализ угроз:_  
Фильтрация по текущему уровню угрозы **_current_threat_level_** в эталоне ведется по кол-ву атак на крепость за последний месяц, я же беру среднюю оценку уровня угрозы.
Следовало добавить условие **_c.active = TRUE_** в выборку идентификаторов существ.
И почему-то первый CTE **_creature_attack_history_** так и не использовался для основного запроса.  

_Сезонные риски:_  
В моем решении, я не учитывал.  
И для текущего сезона выводятся: средняя частота атак для текущего сезона, ожидаемый уровень угроз,
факторы корреляции между частотой атак и различными параметрами (температура, осадки, фаза луны).
Во внутреннем запросе UNION ALL объединяет результаты трех запросов, 
каждый из которых вычисляет корреляцию между частотой атак и одним из факторов (температура, осадки и фаза луны).
Текстовые значения фазы луны переводятся в числовые.  

_Оценка уязвимостей:_  
Сразу видно, что **_vulnerability_score_** рассчитан более взвешено чем у меня `(ca.military_response_time_minutes / 100) + (l.fortification_level / 10)` 
у меня простая формула учитывающая только время ответа отряда и уровень укреплений.
В эталоне же взвешенная формула с 6-ю значениями и нормализация этих значений.
Отношение количества проломов к общему количеству атак, уровень укрепленности зоны (чем ниже уровень укрепленности, тем выше уязвимость),
количество точек доступа в зону (больше точек доступа - выше уязвимость), время реагирования военных (чем меньше время реагирования, тем ниже уязвимость),
количество защитных сооружений (чем больше сооружений, тем ниже уязвимость), количество патрулирующих отрядов (чем больше отрядов, тем ниже уязвимость).
Список отрядов джоинится корректно через **_squad_movement_** **_sm.patrol_zone_id_**. И выводятся 10 самых уязвимых зон.  

_Эффективность защиты:_  
Рассчитано более менее в схожей манере как в эталоне.

_Готовность военных отрядов:_  
**_readiness_score_** как оказалось, присутствует в таблице **_military_stations_** и отдельно рассчитывать его не требуется как это сделал я.
Расчет боевой эффективности более взвешенный и учитываются навыки боя, успешные обороны, качество снаряжения и сколько дней прошло с момента тренировки.
В моем случае я конечно считал проще (умножая кол-во активным членов военного отряда на средний уровень боевых навыков) деля на 100, превращая все это в коэффициент.  


_Эволюцию защитных способностей крепости со временем:_  
Здесь также можно сказать что рассчитано, в схожей с эталоном методике.


_Рекомендации по улучшению безопасности:_  
Финальный отчет, который формирует рекомендации по степени критичности от "Критичного" до "Низкого".
Как раз таки из таблицы **_security_recommendations_** описание которой отсутствует.
Выводятся область фокуса рекомендации, сами рекомендации, оценка необходимых ресурсов и оценка ожидаемого улучшения.
Также связанные сущности: самые уязвимые зоны, отряды с низкой готовностью и структуры защиты (фортификации) требующие обслуживания или улучшения.








