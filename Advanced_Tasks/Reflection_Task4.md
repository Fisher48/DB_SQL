Задание 4* выполнено не совсем верно. Есть некоторые недочеты.

Эталонное решение снова на высоте и делает полнейший анализ эффективности торговли между цивилизациями, анализ импорта/экспорта и всех необходимых метрик и не только.  
Сравнивая свое решение с эталоном, могу сказать, что основные показатели, которые были в примере сделаны почти верно, за исключением некоторых полей.

В CTE **_civilization_trade_history_** идет история торговли цивилизаций, присутствуют дополнительные поля указывающие на кол-во уникальных товаров, импортных и экспортных товаров, 
что нет в моем анализе.

В CTE **_fortress_resource_dependency_** рассчитывается анализ ресурсов крепости по типу материала. 
**_dependency_score_** в эталоне рассчитан более корректно, учитывает кол-во уникальных товаров, общий объем и разнообразие поставщиков (1 / кол-во цивилизаций).
У меня только общий объем на кол-во ресурсов в крепости (процент от локальных запасов). 
Имеется ввиду чем больше цивилизаций привозит определенный товар, тем ниже риск зависимости от данного типа товара.
Разнообразие импорта **_import_diversity_** я считал по кол-ву уникальных типов материалов, в эталоне это кол-во уникальных караванов. 
Тут вопрос в понятии - что подразумевалось под разнообразием импорта.

В CTE **_diplomatic_trade_correlation_** анализируются все дипломатические события для каждой цивилизации их кол-во и исход. 
У меня была мысль, что если **_de.outcome = 'Success'_**, оно ак раз и влияет на **_relationship_change_** указывая на последний исход события 
задавая тон взаимоотношений к цивилизации. Я вижу что в эталоне подход совсем другой, **_trade_relationship_** определяется как разность между экспортом и импортом.
И если она положительная, то взаимоотношения _Благоприятные_ если отрицательная, то наоборот _Неблагоприятные_. Это указано в основном запросе эталона
`'trade_relationship', CASE
WHEN (SUM(cth.export_value) - SUM(cth.import_value)) > 0 THEN 'Favorable'
WHEN (SUM(cth.export_value) - SUM(cth.import_value)) < 0 THEN 'Unfavorable'
ELSE 'Balanced' END`
Корреляция между торговлей и дипломатическими отношениями я понял также, как и в эталоне, но вывел сначала отдельный CTE **_caravans_info_** 
для подсчета общей ценности по караванам и их отношениям, а затем уже в другом CTE **_civilization_data_** делал расчет корреляции.
Эталонный вариант будет поточнее, он считает корреляцию между каждой сделкой и изменением отношений, 
а в моем случае корреляцию между общим объемом торговли и изменением отношений.

В CTE **_workshop_export_effectiveness_** идет анализ эффективности экспорта продукции мастерских. Показатель **_'export_ratio'_** в эталоне рассчитан более корректно.
Он считает отношение экспортируемой продукции к созданной продукции, а в моем случае процент экспорта от общего объема торговли.
Показатель средней наценки экспортного товара **_avg_export_markup_** в эталоне рассчитан корректнее чем у меня. 
Я считаю это - как среднюю флуктуацию цены _**AVG(cg.price_fluctuation)**_ и понимаю сейчас что это неверно.
В эталоне для каждого товара делим цену продажи на себестоимость и усредняем потом, получается все логично. 
И в запросе необходимо указывать при расчете, что мы считаем только экспорт **_WHEN cg.type = 'Export'_**.
И еще отмечу правильный **_JOIN_** между таблицами с товарами караванов и продуктом, по полю **_p.product_id = cg.original_product_id_**.

В CTE **_trade_timeline_** идет анализ эволюции торговых отношений во времени. В сравнении с моим CTE **_trade_timeline_info_**, во-первых, нет привязки к конкретной цивилизации,
что стоило сделать и мне в моем CTE. 
Во-вторых, **_trade_diversity_** у меня считается как уникальные типы материалов, что я уже после просмотра эталона понял что это неверно 
и требовалось указать какие цивилизации между собой торгуют, то есть кол-во уникальных цивилизаций **_COUNT(DISTINCT c.civilization_type)_**.
В эталоне присутствует анализ с предыдущим периодом: 
`LAG(SUM(tt.value)) OVER (ORDER BY EXTRACT(YEAR FROM c.arrival_date), EXTRACT(QUARTER FROM c.arrival_date)) AS previous_quarter_value`,
оконная функция позволяет посчитать рост/падение относительно прошлого квартала.
Группировка также в эталоне корректная **_EXTRACT(YEAR FROM... EXTRACT(QUARTER FROM..._**.

Дальше идут дополнительные анализы по влиянию торговли на экономику крепости и рекомендации основанные на анализе торговли.  
В целом задачи действительно усложняются и становится тяжелее.